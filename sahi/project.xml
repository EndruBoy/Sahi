<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="project">
    <property file="project.properties"/>
    <taskdef name="sahi" classname="net.sf.sahi.ant.RunSahiTask"
             classpath="${sahidir}/lib/ant-sahi.jar"/>

    <target name="run-sahi-tests">
        <sahi suite="${suite}"
              browser="${browser}"
              baseurl="${baseurl}"
              sahihost="localhost"
              sahiport="9999"
              failureproperty="sahi.failed"
              haltonfailure="false"
              threads="3">
            <report type="html"/>
            <report type="junit" logdir="${junit-log-dir}"/>
            <createissue tool="jira"/>            
        </sahi>
    </target>

    <target name="stopserver">
        <echo message="Start server"/>
    </target>

    <target name="startserver">
        <echo message="Stop server"/>
    </target>

    <target name="sahi-tests">
        <antcall target="proxyon"/>
        <parallel>
            <sequential>
                <waitfor maxwait="3" maxwaitunit="minute" checkevery="100">
                    <http url="http://localhost:8882/jetspeed"/>
                </waitfor>
                <antcall target="run-sahi-tests"/>
                <antcall target="failsahi"/>
                <antcall target="stopsahi"/>
                <antcall target="proxyoff"/>
                <antcall target="stopserver"/>
            </sequential>
            <antcall target="startsahi"/>
            <antcall target="startserver"/>
        </parallel>
    </target>

    <target name="failsahi" if="sahi.failed">
        <fail message="Sahi tests failed!"/>
    </target>

    <target name="startsahi" description="starts proxy">
        <java classname="net.sf.sahi.Proxy" fork="true" dir="${sahidir}/bin">
            <env key="MOZ_NO_REMOTE" value="1"/>
            <classpath location="${sahidir}/lib/sahi.jar">
                <fileset dir="extlib" includes="*.jar"/>                
            </classpath>
        </java>
    </target>

    <target name="stopsahi" description="stop sahi server">
        <sahi stop="true" sahihost="localhost" sahiport="9999"/>
    </target>

    <target name="proxyon">
        <exec executable="${sahidir}/tools/toggle_IE_proxy.exe">
            <arg value="enable"/>
        </exec>
    </target>

    <target name="proxyoff">
        <exec executable="${sahidir}/tools/toggle_IE_proxy.exe">
            <arg value="disable"/>
        </exec>
    </target>

</project>